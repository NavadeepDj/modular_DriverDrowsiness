<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Driver Safety Dashboard Overview</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js" onerror="console.log('config.js not found - will use manual input or localStorage')"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#06e0ce",
                        "background-light": "#ffffff",
                        "background-dark": "#17171c",
                        "danger": "#E63838",
                        "warning": "#F78C1B",
                        "safe": "#26B826",
                        "inattentive": "#B366E6",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(6, 224, 206, 0.3);
            transform: translateY(-2px);
        }
        .pulse-live {
            box-shadow: 0 0 0 0 rgba(6, 224, 206, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(6, 224, 206, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(6, 224, 206, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 224, 206, 0); }
        }
        .bg-animated {
            background: linear-gradient(-45deg, #17171c, #1a2a29, #17171c, #0d1e1d);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .refresh-spin {
            animation: refreshSpin 0.5s ease-in-out;
        }
        @keyframes refreshSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .update-flash {
            animation: updateFlash 0.3s ease-out;
        }
        @keyframes updateFlash {
            0% { background: rgba(6, 224, 206, 0.05); }
            100% { background: transparent; }
        }
        
        /* Light Theme Styles */
        body.light-theme {
            background: linear-gradient(-45deg, #f8f9fa, #e9ecef, #f8f9fa, #dee2e6);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: #1a1a1a;
        }
        body.light-theme .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        body.light-theme .glass-card:hover {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(6, 224, 206, 0.4);
        }
        body.light-theme header {
            background: rgba(255, 255, 255, 0.8);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        body.light-theme h2,
        body.light-theme h3,
        body.light-theme p,
        body.light-theme span,
        body.light-theme td,
        body.light-theme th,
        body.light-theme a,
        body.light-theme button:not(.bg-primary) {
            color: #1a1a1a;
        }
        body.light-theme [class*="text-white"] {
            color: #1a1a1a !important;
        }
        body.light-theme [class*="text-white/40"],
        body.light-theme [class*="text-white/50"],
        body.light-theme [class*="text-white/60"],
        body.light-theme [class*="text-white/70"] {
            color: rgba(26, 26, 26, 0.6) !important;
        }
        body.light-theme [class*="text-white/20"],
        body.light-theme [class*="text-white/30"] {
            color: rgba(26, 26, 26, 0.4) !important;
        }
        body.light-theme [class*="bg-white/5"] {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        body.light-theme [class*="bg-white/10"] {
            background: rgba(0, 0, 0, 0.1) !important;
        }
        body.light-theme [class*="bg-white/2"] {
            background: rgba(0, 0, 0, 0.02) !important;
        }
        body.light-theme [class*="border-white/5"],
        body.light-theme [class*="border-white/10"] {
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        body.light-theme [class*="divide-white/5"] {
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        body.light-theme table thead {
            background: rgba(0, 0, 0, 0.03) !important;
        }
        body.light-theme [class*="hover:bg-white"]:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        body.light-theme #themeToggle {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }
        body.light-theme #themeToggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        body.light-theme #themeToggle .material-symbols-outlined {
            color: #1a1a1a;
        }
        body.light-theme .session-avatar {
            background: linear-gradient(to bottom right, #e5e7eb, #d1d5db) !important;
            color: #1a1a1a !important;
        }
        body.light-theme .session-avatar [class*="text-white"] {
            color: #1a1a1a !important;
        }
    </style>
</head>
<body id="body" class="bg-animated font-display text-white min-h-screen">
    <div class="flex h-screen flex-col">
        <header class="flex items-center justify-between border-b border-white/5 bg-background-dark/50 backdrop-blur-md px-10 py-4 sticky top-0 z-50">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="size-8 bg-primary/20 rounded-lg flex items-center justify-center border border-primary/30">
                        <span class="material-symbols-outlined text-primary">monitoring</span>
                    </div>
                    <h2 class="text-white text-xl font-extrabold tracking-tight">Electrifex Dashboard</h2>
                </div>
                <div class="h-6 w-px bg-white/10 mx-2"></div>
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/10 border border-primary/20">
                    <div class="size-2 rounded-full bg-primary pulse-live"></div>
                    <span class="text-[11px] font-bold text-primary uppercase tracking-widest">Live System</span>
                </div>
            </div>
            <div class="flex flex-1 justify-end gap-8 items-center">
                <nav class="flex items-center gap-8">
                    <a class="text-primary text-sm font-semibold border-b-2 border-primary pb-1" href="dashboard.html">Overview</a>
                </nav>
                <div class="flex gap-3">
                    <button onclick="toggleTheme()" id="themeToggle" class="flex items-center justify-center rounded-xl h-10 w-10 bg-white/5 hover:bg-white/10 border border-white/10 transition-all active:scale-95" title="Toggle theme">
                        <span class="material-symbols-outlined text-lg" id="themeIcon">dark_mode</span>
                    </button>
                    <button onclick="manualRefresh()" class="flex min-w-[100px] cursor-pointer items-center justify-center rounded-xl h-10 px-4 bg-primary text-background-dark text-sm font-bold hover:opacity-90 active:scale-95" style="position: relative;">
                        <span class="material-symbols-outlined mr-2 text-lg" id="refreshIcon">refresh</span>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Config Section (Hidden by default) -->
        <div id="configSection" class="px-10 py-4" style="display: none;">
            <div class="glass-card rounded-xl p-6 max-w-2xl mx-auto">
                <h3 class="text-lg font-bold mb-4">Supabase Configuration</h3>
                <div class="flex gap-3">
                    <input type="text" id="supabaseUrl" placeholder="Supabase URL" class="flex-1 px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-primary">
                    <input type="text" id="supabaseKey" placeholder="Supabase Key" class="flex-1 px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-primary">
                    <button onclick="connectSupabase()" class="px-6 py-2 bg-primary text-background-dark rounded-lg font-bold hover:opacity-90">Connect</button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="flex-1 flex items-center justify-center" style="display: none;">
            <div class="text-center">
                <div class="size-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/60">Loading dashboard data...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error" class="px-10 py-4" style="display: none;"></div>

        <!-- Main Dashboard -->
        <main id="dashboard" class="flex-1 overflow-y-auto px-10 py-8" style="display: none;">
            <div class="max-w-[1400px] mx-auto grid grid-cols-12 gap-6">
                <!-- Stats Cards -->
                <div class="col-span-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
                    <div class="glass-card rounded-xl p-6 flex flex-col gap-1 relative overflow-hidden group fade-in">
                        <div class="absolute -right-4 -top-4 size-24 bg-white/5 rounded-full blur-2xl group-hover:bg-primary/10 transition-all"></div>
                        <p class="text-white/50 text-xs font-bold uppercase tracking-wider">Total Sessions</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-3xl font-bold tracking-tight" id="totalSessions">0</h3>
                            <span id="totalSessionsChange" class="text-sm font-bold mb-1"></span>
                        </div>
                        <div class="mt-4 w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-primary/50 rounded-full transition-all duration-1000 ease-out" id="totalSessionsBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 flex flex-col gap-1 relative overflow-hidden group border-primary/20 bg-primary/5 fade-in">
                        <p class="text-primary text-xs font-bold uppercase tracking-wider">Active Sessions</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-3xl font-bold tracking-tight text-white" id="activeSessions">0</h3>
                            <span id="activeSessionsChange" class="text-sm font-bold mb-1"></span>
                        </div>
                        <div class="mt-4 flex gap-1" id="activeSessionsIndicators">
                            <div class="size-1.5 rounded-full bg-primary pulse-live"></div>
                            <div class="size-1.5 rounded-full bg-primary/40"></div>
                            <div class="size-1.5 rounded-full bg-primary/20"></div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 flex flex-col gap-1 relative overflow-hidden group fade-in">
                        <p class="text-white/50 text-xs font-bold uppercase tracking-wider">Total Alerts (24h)</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-3xl font-bold tracking-tight" id="totalAlerts">0</h3>
                            <span id="totalAlertsChange" class="text-sm font-bold mb-1"></span>
                        </div>
                        <div class="mt-4 w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-danger rounded-full transition-all duration-1000 ease-out" id="totalAlertsBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 flex flex-col gap-1 relative overflow-hidden group fade-in">
                        <p class="text-white/50 text-xs font-bold uppercase tracking-wider">Avg Drowsiness</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-3xl font-bold tracking-tight" id="avgDrowsiness">0%</h3>
                            <span id="avgDrowsinessChange" class="text-sm font-bold mb-1"></span>
                        </div>
                        <div class="mt-4 flex items-center gap-2">
                            <span class="text-[10px] text-white/40">Optimal: &lt;10%</span>
                        </div>
                        <div class="mt-2 w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 ease-out" id="avgDrowsinessBar" style="width: 0%; background: linear-gradient(90deg, var(--safe), var(--warning), var(--danger));"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions Table -->
                <div class="col-span-12 lg:col-span-9 flex flex-col gap-6">
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="px-6 py-5 flex items-center justify-between border-b border-white/5">
                            <div>
                                <h2 class="text-lg font-bold">Recent Active Sessions</h2>
                                <p class="text-xs text-white/40" id="sessionsSubtitle"></p>
                            </div>
                            <button class="text-primary text-xs font-bold border border-primary/20 px-3 py-1.5 rounded-lg hover:bg-primary/10 transition-colors">Export CSV</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-white/2">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-white/40 uppercase tracking-wider">Session ID</th>
                                        <th class="px-6 py-4 text-xs font-bold text-white/40 uppercase tracking-wider">Duration</th>
                                        <th class="px-6 py-4 text-xs font-bold text-white/40 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-4 text-xs font-bold text-white/40 uppercase tracking-wider">Fatigue Index</th>
                                        <th class="px-6 py-4 text-xs font-bold text-white/40 uppercase tracking-wider text-right">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="sessionsTableBody" class="divide-y divide-white/5">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- State Distribution Chart -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2 class="text-lg font-bold">Driver State Distribution</h2>
                                <p class="text-xs text-white/40">Fleet-wide focus aggregate (Last 24 Hours)</p>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-lg border border-white/5">
                                    <div class="size-2 rounded-full bg-safe"></div>
                                    <span class="text-[10px] text-white/60 font-bold uppercase">Alert</span>
                                </div>
                                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-lg border border-white/5">
                                    <div class="size-2 rounded-full bg-inattentive"></div>
                                    <span class="text-[10px] text-white/60 font-bold uppercase">Inattentive</span>
                                </div>
                                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-lg border border-white/5">
                                    <div class="size-2 rounded-full bg-warning"></div>
                                    <span class="text-[10px] text-white/60 font-bold uppercase">Drowsy</span>
                                </div>
                                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-lg border border-white/5">
                                    <div class="size-2 rounded-full bg-danger"></div>
                                    <span class="text-[10px] text-white/60 font-bold uppercase">Danger</span>
                                </div>
                            </div>
                        </div>
                        <div id="stateChart" class="flex items-end justify-between h-[180px] gap-2 px-4">
                            <!-- Chart will be generated here -->
                        </div>
                    </div>

                    <!-- Alert Breakdown and Performance - Side by Side -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Alert Breakdown -->
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Alert Breakdown</h2>
                                <span class="text-xs text-white/40" id="alertBreakdownTime">Last 24h</span>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-white/60">Level 1</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg font-bold" id="level1Alerts">0</span>
                                            <span id="level1Change" class="text-xs font-bold"></span>
                                        </div>
                                    </div>
                                    <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-warning rounded-full transition-all duration-1000 ease-out" id="level1Bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-white/60">Level 2</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg font-bold text-danger" id="level2Alerts">0</span>
                                            <span id="level2Change" class="text-xs font-bold"></span>
                                        </div>
                                    </div>
                                    <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-danger rounded-full transition-all duration-1000 ease-out" id="level2Bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-white/5">
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs text-white/40">Total Alerts</span>
                                        <span class="text-sm font-bold" id="totalBreakdownAlerts">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-lg font-bold mb-4">Performance</h2>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex items-end gap-2 mb-1">
                                        <p class="text-2xl font-bold" id="maxScore">0</p>
                                        <span id="maxScoreChange" class="text-xs font-bold mb-1"></span>
                                    </div>
                                    <p class="text-xs text-white/60">Max Score</p>
                                </div>
                                <div>
                                    <div class="flex items-end gap-2 mb-1">
                                        <p class="text-2xl font-bold" id="avgDuration">0 min</p>
                                        <span id="avgDurationChange" class="text-xs font-bold mb-1"></span>
                                    </div>
                                    <p class="text-xs text-white/60">Avg Duration</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-span-12 lg:col-span-3 flex flex-col gap-6">
                    <!-- Recent Alerts -->
                    <div class="glass-card rounded-2xl p-6 flex-1 flex flex-col">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <h2 class="text-lg font-bold">Recent Alerts</h2>
                                <div class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-primary/10 border border-primary/20">
                                    <div class="size-1.5 rounded-full bg-primary pulse-live"></div>
                                    <span class="text-[9px] font-bold text-primary uppercase tracking-wider">LIVE</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="lastUpdateTime" class="text-[9px] text-white/40 font-mono"></span>
                                <span id="newAlertsBadge" class="size-6 bg-danger/10 text-danger rounded flex items-center justify-center text-[10px] font-bold border border-danger/20" style="display: none;">0</span>
                            </div>
                        </div>
                        <div id="recentAlerts" class="flex flex-col gap-4">
                        </div>
                        <button class="w-full mt-auto py-3 text-xs font-bold text-white/40 hover:text-white transition-colors border-t border-white/5 pt-4">VIEW ALL ACTIVITY</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let supabaseClient = null;
        
        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('dashboardTheme') || 'dark';
            applyTheme(savedTheme);
        }
        
        function toggleTheme() {
            const body = document.getElementById('body');
            const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('dashboardTheme', newTheme);
        }
        
        function applyTheme(theme) {
            const body = document.getElementById('body');
            const themeIcon = document.getElementById('themeIcon');
            
            if (theme === 'light') {
                body.classList.remove('bg-animated');
                body.classList.add('light-theme');
                themeIcon.textContent = 'light_mode';
            } else {
                body.classList.remove('light-theme');
                body.classList.add('bg-animated');
                themeIcon.textContent = 'dark_mode';
            }
        }
        
        // Constants
        const EMPTY_STATES = {
            NO_SESSIONS: '<tr><td colspan="5" class="px-6 py-8 text-center text-white/40">No sessions found</td></tr>',
            NO_ALERTS: '<div class="text-center py-8 text-white/40 text-sm">No alerts in the last 24 hours</div>',
            NO_DATA: '<div class="text-center text-white/40 text-sm w-full">No data available</div>',
            NO_DATA_24H: '<div class="text-center text-white/40 text-sm w-full">No data in last 24 hours</div>',
            LOADING_SESSIONS: 'Loading sessions...',
            LOADING_ALERTS: '<div class="text-center py-8 text-white/40 text-sm">Loading alerts...</div>',
            LOADING_TABLE: '<tr><td colspan="5" class="px-6 py-8 text-center text-white/40">Loading...</td></tr>'
        };
        
        const DEFAULT_VALUES = {
            PERCENT: '0%',
            MINUTES: '0 min',
            NUMBER: '0',
            ZERO_WIDTH: '0%'
        };
        
        const TIME_INTERVALS = {
            HOUR_MS: 3600000,
            DAY_MS: 24 * 3600000,
            REFRESH_MS: 2000  // 2 seconds for streaming updates
        };

        
        let previousStats = {
            totalSessions: 0,
            activeSessions: 0,
            totalAlerts: 0,
            avgDrowsiness: 0,
            level1Alerts: 0,
            level2Alerts: 0,
            maxScore: 0,
            avgDuration: 0
        };
        let refreshInterval = null;
        let previousAlerts = [];
        let isStreamingMode = false;  // Track if we're in streaming update mode

        // Load from config.js (generated from .env) or localStorage
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize theme first
            initTheme();
            
            let url = null;
            let key = null;
            
            // First, try to load from config.js (generated from .env)
            if (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG) {
                url = SUPABASE_CONFIG.url;
                key = SUPABASE_CONFIG.key;
                console.log('âœ… Loaded credentials from config.js (generated from .env)');
            }
            
            // Fallback to localStorage
            if (!url || !key) {
                url = localStorage.getItem('supabaseUrl');
                key = localStorage.getItem('supabaseKey');
                if (url && key) {
                    console.log('ðŸ“¦ Loaded credentials from localStorage');
                }
            }
            
            // Populate form fields
            if (url) document.getElementById('supabaseUrl').value = url;
            if (key) document.getElementById('supabaseKey').value = key;
            
            // Auto-connect if credentials are available
            if (url && key) {
                document.getElementById('configSection').style.display = 'none';
                connectSupabase();
            } else {
                document.getElementById('configSection').style.display = 'block';
                console.log('âš ï¸ No credentials found. Please configure Supabase in .env file and run generate_config.py');
            }
        });

        function connectSupabase() {
            const url = document.getElementById('supabaseUrl')?.value.trim() || localStorage.getItem('supabaseUrl');
            const key = document.getElementById('supabaseKey')?.value.trim() || localStorage.getItem('supabaseKey');

            if (!url || !key) {
                showError('Please enter both Supabase URL and Key');
                return;
            }

            try {
                supabaseClient = supabase.createClient(url, key);
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                document.getElementById('configSection').style.display = 'none';
                showError('', false);
                loadDashboard();
            } catch (error) {
                showError('Failed to connect to Supabase: ' + error.message);
            }
        }

        // Manual refresh - always uses streaming mode (no full page refresh)
        function manualRefresh() {
            const dashboard = document.getElementById('dashboard');
            const isVisible = dashboard && dashboard.style.display !== 'none';
            // Always use streaming mode if dashboard is visible, otherwise initial load
            if (isVisible) {
                loadDashboard(true);  // Force streaming mode
            } else {
                loadDashboard(false);  // Initial load
            }
        }

        async function loadDashboard(isStreaming = false) {
            if (!supabaseClient) {
                showError('Please connect to Supabase first');
                return;
            }

            // Set global streaming mode flag
            isStreamingMode = isStreaming;

            // Only show loading screen on initial load, not during streaming updates
            if (!isStreaming) {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('error').style.display = 'none';
            }

            try {
                const [sessions, alerts, snapshots] = await Promise.all([
                    loadSessions(),
                    loadAlerts(),
                    loadSnapshots()
                ]);

                // Update all sections - faster updates for streaming mode
                if (isStreaming) {
                    // Streaming mode: update immediately without delays
                    updateStats(sessions, alerts, snapshots);
                    updateSessionsTable(sessions);
                    updateRecentAlerts(alerts);
                    updateStateChart(snapshots);
                } else {
                    // Initial load: use staggered animations
                    updateStats(sessions, alerts, snapshots);
                    setTimeout(() => updateSessionsTable(sessions), 200);
                    setTimeout(() => updateRecentAlerts(alerts), 300);
                    setTimeout(() => updateStateChart(snapshots), 400);
                }

                if (!isStreaming) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    // Start auto-refresh if not already started
                    if (!refreshInterval) {
                        setTimeout(() => startAutoRefresh(), 2000);
                    }
                }
            } catch (error) {
                showError('Error loading dashboard: ' + error.message);
                if (!isStreaming) {
                    document.getElementById('loading').style.display = 'none';
                }
            }
        }

        async function loadSessions() {
            const { data, error } = await supabaseClient
                .from('driving_sessions')
                .select('*')
                .order('started_at', { ascending: false })
                .limit(50);
            if (error) throw error;
            return data || [];
        }

        async function loadAlerts() {
            const { data, error } = await supabaseClient
                .from('alert_events')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(20);
            if (error) throw error;
            return data || [];
        }

        async function loadSnapshots() {
            // Load more snapshots for better time-based distribution (last 24 hours)
            const last24h = new Date(Date.now() - TIME_INTERVALS.DAY_MS).toISOString();
            const { data, error } = await supabaseClient
                .from('driver_snapshots')
                .select('*')
                .gte('timestamp', last24h)
                .order('timestamp', { ascending: false })
                .limit(500); // More data for better distribution
            if (error) throw error;
            return data || [];
        }

        // Animate number with trend indicator
        function animateNumberWithTrend(elementId, newValue, changeElementId, previousValue, format = 'number', isStreaming = false) {
            const element = document.getElementById(elementId);
            const changeElement = document.getElementById(changeElementId);
            const startValue = parseFloat(element.textContent.replace(/[^0-9.]/g, '')) || previousValue || 0;
            
            // Calculate change
            const change = newValue - startValue;
            const changePercent = startValue > 0 ? ((change / startValue) * 100) : 0;
            
            // Update trend indicator (only show significant changes in streaming mode)
            if (changeElement && Math.abs(change) > (isStreaming ? 1 : 0.1)) {
                const isPositive = change > 0;
                const changeClass = isPositive ? 'text-safe' : 'text-danger';
                const changeSymbol = isPositive ? '+' : '';
                const displayValue = Math.abs(changePercent) > 0.1 ? changePercent.toFixed(1) + '%' : changeSymbol + change.toFixed(0);
                changeElement.textContent = changeSymbol + displayValue;
                changeElement.className = `text-sm font-bold mb-1 ${changeClass}`;
                changeElement.style.display = 'inline';
            } else if (changeElement) {
                changeElement.style.display = 'none';
            }
            
            // Animate number with streaming mode support
            animateValue(element, startValue, newValue, 800, format, isStreaming);
            
            // Update previous value
            previousStats[elementId] = newValue;
        }

        // Enhanced animate value function with streaming mode support
        function animateValue(element, start, end, duration = 800, format = 'number', isStreaming = false) {
            // Use faster animations for streaming updates
            if (isStreaming && duration > 300) {
                duration = 300;
            }
            const startTime = performance.now();
            const isNumber = typeof end === 'number';
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const current = start + (end - start) * easeOutQuart;
                
                if (format === 'number') {
                    element.textContent = Math.round(current).toLocaleString();
                } else if (format === 'percent') {
                    element.textContent = Math.round(current) + '%';
                } else if (format === 'decimal') {
                    element.textContent = current.toFixed(1);
                } else {
                    element.textContent = isNumber ? Math.round(current) : end;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    if (format === 'number') {
                        element.textContent = Math.round(end).toLocaleString();
                    } else if (format === 'percent') {
                        element.textContent = Math.round(end) + '%';
                    } else if (format === 'decimal') {
                        element.textContent = end.toFixed(1);
                    } else {
                        element.textContent = isNumber ? Math.round(end) : end;
                    }
                }
            }
            
            requestAnimationFrame(update);
        }

        function updateStats(sessions, alerts, snapshots) {
            // Total Sessions
            const totalSessions = sessions.length;
            animateNumberWithTrend('totalSessions', totalSessions, 'totalSessionsChange', previousStats.totalSessions, 'number', isStreamingMode);
            const totalPercent = Math.min((totalSessions / 100) * 100, 100);
            if (isStreamingMode) {
                document.getElementById('totalSessionsBar').style.width = totalPercent + '%';
            } else {
                setTimeout(() => {
                    document.getElementById('totalSessionsBar').style.width = totalPercent + '%';
                }, 100);
            }

            // Active Sessions
            const active = sessions.filter(s => s.status === 'active').length;
            animateNumberWithTrend('activeSessions', active, 'activeSessionsChange', previousStats.activeSessions, 'number', isStreamingMode);
            
            // Update active indicators dynamically
            const indicators = document.getElementById('activeSessionsIndicators');
            if (indicators) {
                if (active > 0) {
                    const indicatorCount = Math.min(active, 10);
                    indicators.innerHTML = Array.from({length: indicatorCount}).map((_, i) => 
                        `<div class="size-1.5 rounded-full bg-primary ${i < 3 ? 'pulse-live' : ''}" style="opacity: ${Math.max(0.2, 1 - (i * 0.1))}"></div>`
                    ).join('');
                } else {
                    indicators.innerHTML = '<div class="size-1.5 rounded-full bg-white/20"></div>';
                }
            }

            // Total Alerts (24h)
            const last24h = new Date(Date.now() - TIME_INTERVALS.DAY_MS);
            const recentAlerts = alerts.filter(a => new Date(a.timestamp) >= last24h);
            const alertCount = recentAlerts.length;
            animateNumberWithTrend('totalAlerts', alertCount, 'totalAlertsChange', previousStats.totalAlerts, 'number', isStreamingMode);
            const alertsPercent = Math.min((alertCount / 200) * 100, 100);
            if (isStreamingMode) {
                document.getElementById('totalAlertsBar').style.width = alertsPercent + '%';
            } else {
                setTimeout(() => {
                    document.getElementById('totalAlertsBar').style.width = alertsPercent + '%';
                }, 100);
            }

            // Average Drowsiness
            const completedSessions = sessions.filter(s => s.status === 'completed' && s.avg_drowsiness_score);
            if (completedSessions.length > 0) {
                const avg = completedSessions.reduce((sum, s) => sum + parseFloat(s.avg_drowsiness_score || 0), 0) / completedSessions.length;
                animateNumberWithTrend('avgDrowsiness', avg, 'avgDrowsinessChange', previousStats.avgDrowsiness, 'percent', isStreamingMode);
                if (isStreamingMode) {
                    document.getElementById('avgDrowsinessBar').style.width = Math.min(avg, 100) + '%';
                } else {
                    setTimeout(() => {
                        document.getElementById('avgDrowsinessBar').style.width = Math.min(avg, 100) + '%';
                    }, 100);
                }
            } else {
                document.getElementById('avgDrowsiness').textContent = DEFAULT_VALUES.PERCENT;
                document.getElementById('avgDrowsinessBar').style.width = DEFAULT_VALUES.ZERO_WIDTH;
            }

            // Alert Breakdown - Enhanced with trends
            const level1 = recentAlerts.filter(a => a.alert_level === 1).length;
            const level2 = recentAlerts.filter(a => a.alert_level === 2).length;
            const totalAlertCount = level1 + level2;
            
            // Animate Level 1 with trend
            const prevLevel1 = previousStats.level1Alerts || 0;
            animateNumberWithTrend('level1Alerts', level1, 'level1Change', prevLevel1, 'number', isStreamingMode);
            previousStats.level1Alerts = level1;
            
            // Animate Level 2 with trend
            const prevLevel2 = previousStats.level2Alerts || 0;
            animateNumberWithTrend('level2Alerts', level2, 'level2Change', prevLevel2, 'number', isStreamingMode);
            previousStats.level2Alerts = level2;
            
            // Update total breakdown alerts
            animateValue(document.getElementById('totalBreakdownAlerts'), 
                parseFloat(document.getElementById('totalBreakdownAlerts').textContent) || 0, 
                totalAlertCount, 600, 'number', isStreamingMode);
            
            // Animate progress bars
            if (totalAlertCount > 0) {
                const level1Percent = (level1 / totalAlertCount) * 100;
                const level2Percent = (level2 / totalAlertCount) * 100;
                if (isStreamingMode) {
                    document.getElementById('level1Bar').style.width = level1Percent + '%';
                    document.getElementById('level2Bar').style.width = level2Percent + '%';
                } else {
                    setTimeout(() => {
                        document.getElementById('level1Bar').style.width = level1Percent + '%';
                        document.getElementById('level2Bar').style.width = level2Percent + '%';
                    }, 100);
                }
            } else {
                document.getElementById('level1Bar').style.width = DEFAULT_VALUES.ZERO_WIDTH;
                document.getElementById('level2Bar').style.width = DEFAULT_VALUES.ZERO_WIDTH;
            }

            // Performance Metrics - Enhanced with trends
            const maxScore = Math.max(...sessions.map(s => parseFloat(s.max_drowsiness_score || 0)), 0);
            const prevMaxScore = previousStats.maxScore || 0;
            animateNumberWithTrend('maxScore', maxScore, 'maxScoreChange', prevMaxScore, 'number', isStreamingMode);
            previousStats.maxScore = maxScore;
            
            const durations = completedSessions.map(s => parseFloat(s.duration_seconds || 0));
            if (durations.length > 0) {
                const avgDur = durations.reduce((a, b) => a + b, 0) / durations.length / 60;
                const prevAvgDur = previousStats.avgDuration || 0;
                const change = avgDur - prevAvgDur;
                
                // Animate duration value
                animateValue(document.getElementById('avgDuration'), prevAvgDur, avgDur, 800, 'decimal', isStreamingMode);
                
                // Show trend indicator
                const changeElement = document.getElementById('avgDurationChange');
                if (changeElement && Math.abs(change) > 0.1) {
                    const isPositive = change > 0;
                    const changeClass = isPositive ? 'text-safe' : 'text-danger';
                    const changeSymbol = isPositive ? '+' : '';
                    changeElement.textContent = changeSymbol + change.toFixed(1) + ' min';
                    changeElement.className = `text-xs font-bold mb-1 ${changeClass}`;
                    changeElement.style.display = 'inline';
                } else if (changeElement) {
                    changeElement.style.display = 'none';
                }
                
                previousStats.avgDuration = avgDur;
            } else {
                document.getElementById('avgDuration').textContent = DEFAULT_VALUES.MINUTES;
                const changeElement = document.getElementById('avgDurationChange');
                if (changeElement) changeElement.style.display = 'none';
                previousStats.avgDuration = 0;
            }
        }

        function updateSessionsTable(sessions) {
            const tbody = document.getElementById('sessionsTableBody');
            const activeCount = sessions.filter(s => s.status === 'active').length;
            const totalCount = sessions.length;
            document.getElementById('sessionsSubtitle').textContent = `Live tracking of ${activeCount} active drivers â€¢ ${totalCount} total sessions`;

            if (sessions.length === 0) {
                tbody.innerHTML = EMPTY_STATES.NO_SESSIONS;
                return;
            }

            // Sort: active sessions first, then by start time
            const sortedSessions = [...sessions].sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                return new Date(b.started_at) - new Date(a.started_at);
            });

            tbody.innerHTML = sortedSessions.slice(0, 10).map((session, index) => {
                const startTime = new Date(session.started_at);
                const endTime = session.ended_at ? new Date(session.ended_at) : new Date();
                const duration = session.duration_seconds ? formatDuration(session.duration_seconds) : 'N/A';
                const score = parseFloat(session.avg_drowsiness_score || 0);
                const maxScore = parseFloat(session.max_drowsiness_score || 0);
                const state = getStateFromScore(maxScore);
                const stateConfig = getStateConfig(state);

                // Generate initials from session ID
                const initials = session.session_id.substring(8, 10).toUpperCase();

                const isActive = session.status === 'active';
                const activeIndicator = isActive ? '<div class="size-2 rounded-full bg-primary pulse-live absolute -top-1 -right-1"></div>' : '';
                
                const animationStyle = isStreamingMode ? '' : `style="animation: fadeIn 0.3s ease ${index * 0.05}s both"`;
                return `
                    <tr class="hover:bg-white/[0.02] transition-colors group ${isActive ? 'bg-primary/5' : ''}" ${animationStyle}>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="session-avatar size-8 rounded-lg bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-[10px] font-bold text-white/80 relative">
                                    ${initials}
                                    ${activeIndicator}
                                </div>
                                <span class="text-xs font-mono text-white/50">${session.session_id}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-white/60 font-mono">${duration}</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-full text-[10px] font-bold ${stateConfig.bg} ${stateConfig.text} ${stateConfig.border}">${state}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-1 rounded-full bg-white/5 overflow-hidden">
                                    <div class="h-full ${stateConfig.barColor} transition-all duration-1000 ease-out" style="width: ${maxScore}%"></div>
                                </div>
                                <span class="text-xs font-bold ${stateConfig.scoreColor}">${maxScore.toFixed(0)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right text-sm font-bold">${score.toFixed(0)}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateRecentAlerts(alerts) {
            const container = document.getElementById('recentAlerts');
            const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
            
            // Add flash animation in streaming mode
            if (isStreamingMode && container) {
                container.classList.add('update-flash');
                setTimeout(() => {
                    container.classList.remove('update-flash');
                }, 300);
            }
            
            // Update last update timestamp
            if (lastUpdateTimeEl) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                lastUpdateTimeEl.textContent = timeStr;
            }
            
            const last24h = new Date(Date.now() - TIME_INTERVALS.DAY_MS);
            const recent = alerts.filter(a => new Date(a.timestamp) >= last24h);
            const oneHourAgo = new Date(Date.now() - TIME_INTERVALS.HOUR_MS);

            // Find new alerts (not in previous list)
            const newAlertIds = new Set(recent.filter(a => new Date(a.timestamp) >= oneHourAgo).map(a => a.id));
            const previousAlertIds = new Set(previousAlerts.map(a => a.id));
            const actuallyNew = recent.filter(a => newAlertIds.has(a.id) && !previousAlertIds.has(a.id));
            
            const newAlertsCount = recent.filter(a => new Date(a.timestamp) >= oneHourAgo).length;
            if (newAlertsCount > 0) {
                document.getElementById('newAlertsBadge').textContent = newAlertsCount;
                document.getElementById('newAlertsBadge').style.display = 'flex';
                // Pulse animation for new alerts
                document.getElementById('newAlertsBadge').classList.add('animate-pulse');
            } else {
                document.getElementById('newAlertsBadge').style.display = 'none';
                document.getElementById('newAlertsBadge').classList.remove('animate-pulse');
            }

            if (recent.length === 0) {
                container.innerHTML = EMPTY_STATES.NO_ALERTS;
                previousAlerts = [];
                return;
            }

            // Sort by timestamp (newest first) and take top 5
            const sortedRecent = [...recent].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedRecent.slice(0, 5).map((alert, index) => {
                const time = new Date(alert.timestamp);
                const timeStr = time.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const isNew = actuallyNew.some(a => a.id === alert.id);
                const isLevel2 = alert.alert_level === 2;
                const levelText = `LEVEL ${alert.alert_level}`;
                const borderClass = isLevel2 ? 'border-danger' : 'border-warning';
                const bgClass = isLevel2 ? 'bg-danger/20' : 'bg-warning/20';
                const textClass = isLevel2 ? 'text-danger' : 'text-warning';
                const borderBadgeClass = isLevel2 ? 'border-danger/30' : 'border-warning/30';
                
                // Calculate relative time
                const secondsAgo = Math.floor((Date.now() - time.getTime()) / 1000);
                let relativeTime = '';
                if (secondsAgo < 60) {
                    relativeTime = `${secondsAgo}s ago`;
                } else if (secondsAgo < 3600) {
                    relativeTime = `${Math.floor(secondsAgo / 60)}m ago`;
                } else {
                    relativeTime = `${Math.floor(secondsAgo / 3600)}h ago`;
                }
                
                const alertAnimationStyle = isStreamingMode ? '' : `style="animation: fadeIn 0.4s ease ${index * 0.1}s both"`;
                return `
                    <div class="p-4 rounded-xl bg-white/5 border-l-4 ${borderClass} hover:bg-white/10 transition-all cursor-pointer group ${isNew ? 'animate-pulse border-l-8' : ''}" ${alertAnimationStyle}>
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold ${bgClass} ${textClass} px-1.5 py-0.5 rounded border ${borderBadgeClass}">${levelText}</span>
                                ${isNew ? '<span class="text-[8px] font-bold bg-primary/20 text-primary px-1.5 py-0.5 rounded border border-primary/30 animate-pulse">NEW</span>' : ''}
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-white/30 font-mono block">${timeStr}</span>
                                <span class="text-[8px] text-white/20">${relativeTime}</span>
                            </div>
                        </div>
                        <p class="text-xs text-white/70 leading-relaxed font-medium">${alert.trigger_reason || alert.driver_state || 'Alert triggered'}</p>
                        <div class="mt-3 flex items-center justify-end">
                            <span class="text-[10px] font-bold text-primary opacity-0 group-hover:opacity-100 transition-opacity">REVIEW CLIP â†’</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Store current alerts for next comparison
            previousAlerts = sortedRecent.slice(0, 5);
        }

        function updateStateChart(snapshots) {
            const container = document.getElementById('stateChart');
            
            if (snapshots.length === 0) {
                container.innerHTML = EMPTY_STATES.NO_DATA;
                return;
            }

            // Filter snapshots from last 24 hours
            const last24h = new Date(Date.now() - TIME_INTERVALS.DAY_MS);
            const recentSnapshots = snapshots.filter(s => new Date(s.timestamp) >= last24h);

            if (recentSnapshots.length === 0) {
                container.innerHTML = EMPTY_STATES.NO_DATA_24H;
                return;
            }

            // Group snapshots by time periods
            const timePeriods = [
                { label: '00:00', start: 0, end: 6 },
                { label: '06:00', start: 6, end: 12 },
                { label: '12:00', start: 12, end: 18 },
                { label: '18:00', start: 18, end: 22 },
                { label: '22:00', start: 22, end: 24 },
                { label: 'NOW', isNow: true }
            ];

            // State color mapping
            const stateColors = {
                'ALERT': { bg: 'bg-safe/20', border: 'border-safe', hover: 'hover:bg-safe/30' },
                'SLIGHTLY_DROWSY': { bg: 'bg-warning/20', border: 'border-warning', hover: 'hover:bg-warning/30' },
                'DROWSY': { bg: 'bg-warning/20', border: 'border-warning', hover: 'hover:bg-warning/30' },
                'VERY_DROWSY': { bg: 'bg-danger/20', border: 'border-danger', hover: 'hover:bg-danger/30' },
                'INATTENTIVE': { bg: 'bg-inattentive/20', border: 'border-inattentive', hover: 'hover:bg-inattentive/30' },
                'NO_FACE': { bg: 'bg-primary/20', border: 'border-primary', hover: 'hover:bg-primary/30' }
            };

            // Calculate distribution for each time period
            const periodData = timePeriods.map(period => {
                let periodSnapshots = [];
                
                if (period.isNow) {
                    // For "NOW", use last hour of data
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    periodSnapshots = recentSnapshots.filter(s => new Date(s.timestamp) >= oneHourAgo);
                } else {
                    // For other periods, filter by hour range
                    periodSnapshots = recentSnapshots.filter(s => {
                        const snapshotHour = new Date(s.timestamp).getHours();
                        return snapshotHour >= period.start && snapshotHour < period.end;
                    });
                }

                // Count states in this period
                const stateCounts = {};
                periodSnapshots.forEach(s => {
                    const state = s.driver_state || 'NO_FACE';
                    stateCounts[state] = (stateCounts[state] || 0) + 1;
                });

                // Find dominant state (most common)
                const total = periodSnapshots.length;
                let dominantState = 'ALERT';
                let maxCount = 0;
                Object.keys(stateCounts).forEach(state => {
                    if (stateCounts[state] > maxCount) {
                        maxCount = stateCounts[state];
                        dominantState = state;
                    }
                });

                const colorConfig = stateColors[dominantState] || stateColors['ALERT'];

                return {
                    label: period.label,
                    total: total,
                    dominantState: dominantState,
                    colorConfig: colorConfig,
                    stateCounts: stateCounts
                };
            });

            // Find max total for scaling
            const maxTotal = Math.max(...periodData.map(p => p.total), 1);

            // Render chart
            container.innerHTML = periodData.map((period, index) => {
                // Calculate height based on total snapshots in period
                const height = (period.total / maxTotal) * 100;
                const minHeight = period.total > 0 ? 10 : 0; // Minimum height if there's data
                const finalHeight = Math.max(height, minHeight);

                // Tooltip with state breakdown
                const stateBreakdown = Object.keys(period.stateCounts)
                    .map(state => {
                        const count = period.stateCounts[state];
                        const percent = period.total > 0 ? ((count / period.total) * 100).toFixed(0) : 0;
                        return `${state.replace('_', ' ')}: ${percent}%`;
                    })
                    .join(', ');

                const stateLabel = period.dominantState.replace('_', ' ').toLowerCase();

                return `
                    <div class="flex-1 flex flex-col items-center gap-3 group relative" title="${period.label}: ${period.total} snapshots - ${stateBreakdown}">
                        <div class="w-full ${period.colorConfig.bg} border-t-2 ${period.colorConfig.border} rounded-t-lg transition-all ${period.colorConfig.hover} cursor-pointer relative" style="height: ${finalHeight}%; min-height: ${minHeight}px;">
                            ${period.total > 0 ? `<div class="absolute top-1 left-1/2 -translate-x-1/2 text-[8px] font-bold text-white/60">${period.total}</div>` : ''}
                        </div>
                        <span class="text-[10px] font-bold text-white/40 tracking-wider">${period.label}</span>
                        ${period.total > 0 ? `<span class="text-[8px] text-white/30 mt-[-4px]">${stateLabel}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function getStateFromScore(score) {
            if (score < 25) return 'ALERT';
            if (score < 55) return 'SLIGHTLY_DROWSY';
            if (score < 80) return 'DROWSY';
            return 'VERY_DROWSY';
        }

        function getStateConfig(state) {
            const configs = {
                'ALERT': { bg: 'bg-safe/10', text: 'text-safe', border: 'border border-safe/20', barColor: 'bg-primary', scoreColor: 'text-white' },
                'SLIGHTLY_DROWSY': { bg: 'bg-warning/10', text: 'text-warning', border: 'border border-warning/20', barColor: 'bg-warning', scoreColor: 'text-warning' },
                'DROWSY': { bg: 'bg-warning/10', text: 'text-warning', border: 'border border-warning/20', barColor: 'bg-warning', scoreColor: 'text-warning' },
                'VERY_DROWSY': { bg: 'bg-danger/10', text: 'text-danger', border: 'border border-danger/20', barColor: 'bg-danger', scoreColor: 'text-danger' },
                'INATTENTIVE': { bg: 'bg-inattentive/10', text: 'text-inattentive', border: 'border border-inattentive/20', barColor: 'bg-inattentive', scoreColor: 'text-inattentive' }
            };
            return configs[state] || configs['ALERT'];
        }

        function showError(message, show = true) {
            const errorDiv = document.getElementById('error');
            if (show && message) {
                errorDiv.innerHTML = `<div class="glass-card rounded-xl p-4 border-l-4 border-danger text-danger">${message}</div>`;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        // Auto-refresh every 2 seconds with streaming updates (no page reload)
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (supabaseClient) {
                    // Visual feedback on refresh icon only - keeps button position stable
                    const refreshIcon = document.getElementById('refreshIcon');
                    if (refreshIcon) {
                        // Remove any existing inline styles to prevent layout shifts
                        refreshIcon.style.transform = '';
                        refreshIcon.style.transition = '';
                        // Add animation class to icon only
                        refreshIcon.classList.add('refresh-spin');
                        // Remove class after animation completes
                        setTimeout(() => {
                            refreshIcon.classList.remove('refresh-spin');
                        }, 500);
                    }
                    // Use streaming mode - updates data without hiding dashboard
                    loadDashboard(true);
                }
            }, TIME_INTERVALS.REFRESH_MS);
        }

    </script>
</body>
</html>
